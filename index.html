<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>send_Discord</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="referrer" content="no-referrer" />
	<meta http-equiv="refresh" content="300">
	<link rel="stylesheet" href="https://n138-kz.github.io/lib/master.css?t=0">
	<script src="https://n138-kz.github.io/lib/master.js"></script>
	<script>
		init_setTopMaker();
		init_setFavicon('https://www.google.com/s2/favicons?size=64&domain='+'https://discord.com');
		init_setHeaderText();
	</script>
	<script>
		if (!!location.protocol.match(/https?:/) && location.origin!='https://n138-kz.github.io') {
			location.replace('https://n138-kz.github.io/send_Discord/');
		}
	</script>
	<script>
        async function getConfig(path='config.json') {
            let url=(location.origin+location.pathname).replace(/\/index.html?/,'/')+path;

            const response = await fetch(url);
            const json = await response.json();
            return await json;
        }
        async function pushToDiscord(form_id=null) {
            try {
                if(form_id==false){throw new Error('form_id: Null');}
                const FORM=document.querySelector('form#'+form_id);

                /* Config **/
                let saved_config=localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.'+'n138kz.send_Discord.config' );
                saved_config=saved_config?saved_config:{};
                let loaded_config=await getConfig();
                running_config=loaded_config.external.discord.webhooks[0];
                running_config.username=navigator.userAgent.toLowerCase();

                console.warn([loaded_config,saved_config,running_config]);
                console.warn(Object.assign({},running_config, saved_config));
                
                
                /* Discord endpoint **/
                let wh_endpoint=running_config.webhook_url;
                wh_endpoint=wh_endpoint.split('/');
                wh_endpoint[wh_endpoint.length-2]=atob(wh_endpoint[wh_endpoint.length-2]);
                wh_endpoint[wh_endpoint.length-1]=atob(wh_endpoint[wh_endpoint.length-1]);
                wh_endpoint=wh_endpoint.join('/');
                FORM.action=wh_endpoint;
                
                let url=wh_endpoint;
                let header=new Headers();
                header.append('Content-Type', 'multipart/form-data');
                let files=document.querySelector('#send_Discord_files').files;
                let content=document.querySelector('#send_Discord_content').value+'\n```json\n'+JSON.stringify({
                    'message': document.querySelector('#send_Discord_content').value,
                    'remote_address': JSON.parse(sessionStorage.getItem( (btoa(location.href)).slice(0, 16) + '.'+'n138kz.isJP' )),
                    'location_href': location.origin+location.pathname,
                    'event_at': new Date().getTime()/10**3,
                })+'\n```';
    
                let data=new FormData();
                data.append('content', content);
                //data.append('file', files[0]);
                console.log({
                    url: url,
                    headers: header,
                    files: files,
                    content: content,
                    data: data,
                });
                console.log(...data.entries());
    
                let response = await fetch(url,{
                    method: 'POST',
                    mode: 'cors',
                    headers: header,
                    body: data,
                });
                let json = await response.json();
                console.log({
                    'response': await json,
                });
            } catch (error) {
                console.error(error);
            } finally {
                Array.from(document.querySelectorAll('form')).map((form)=>{
                    form.action='';
                });
            }
        }
        window.addEventListener('DOMContentLoaded', async ()=>{
            let domitem=[];
            const isJP=await getIPaddress();
            if (!isJP.result.result) { location.replace('https://n138-kz.github.io/'); }
            sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'n138kz.isJP', JSON.stringify(isJP) );
            console.log('n138kz.isJP', isJP);
            const remote_addr=isJP.request;
            domitem[0]=document.createElement('a');
            domitem[0].href=`https://ipinfo.io/${remote_addr.request}`;
            domitem[0].innerText=`${remote_addr.detail}`;
            document.querySelector('#remote_address_print').appendChild(domitem[0]);

            try {
                const github_repos=await getGithubRepos('n138-kz/send_Discord');
                sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'github.repos.current', JSON.stringify(github_repos) );
                sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'github.repos.'+github_repos.full_name.replace('/','.'), JSON.stringify(github_repos) );
                console.log('github.repos.current', github_repos);
                console.log('github.repos.'+github_repos.full_name.replace('/','.'), github_repos);
                const github_deploy=await getGithubDeployment(github_repos);
                sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'github.deploy.latest', JSON.stringify(github_deploy) );
                console.log('github.deploy.latest', github_deploy);
            } catch (error) {
                console.warn('Exception error has occurred. But process has continue.');
                console.error(error);
            }
            const github_rates=await getGithubRatelimit();
            sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'github.ratelimit', JSON.stringify(github_rates) );
            console.log('github.ratelimit', github_rates);
            
            document.querySelector('#send_Discord_files').addEventListener('change',(e)=>{
                console.log(e.target.files);
                document.querySelector('#send_Discord_content').value='Attated files:';
                Array.from(e.target.files).map((e1)=>{
                    document.querySelector('#send_Discord_content').value+=` ${e1.name}`;
                });
                if (document.querySelector('#send_Discord_content').value.length>=2000) {
                    document.querySelector('#send_Discord_content').value='Attated '+Array.from(e.target.files).length+' files';
                }
            });
		});
	</script>
</head>
<body>
    <form action="" method="POST" accept="multipart/form-data" id="send_Discord_main">
        <table>
            <thead>
                <tr>
                    <th></th>
                    <td><span id="remote_address_print"></span></td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>Files</th>
                    <td>
                        <input type="file" name="files" id="send_Discord_files" multiple>
                    </td>
                </tr>
                <tr>
                    <th>Description</th>
                    <td>
                        <input type="text" name="content" id="send_Discord_content" required>
                    </td>
                </tr>
                <tr>
                    <th></th>
                    <td>
                        <input type="button" value="Submit" onclick="pushToDiscord(this.parentNode.parentNode.parentNode.parentNode.parentNode.id)">
                    </td>
                </tr>
            </tbody>
        </table>
    </form>
</body>
</html>
