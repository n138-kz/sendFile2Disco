<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sendFile2Disco</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="referrer" content="no-referrer" />
	<meta http-equiv="refresh" content="300">
	<link rel="stylesheet" href="https://n138-kz.github.io/lib/master.css?t=0">
	<script src="https://n138-kz.github.io/lib/master.js"></script>
	<script>
		init_setTopMaker();
		init_setFavicon('https://www.google.com/s2/favicons?size=64&domain='+'https://discord.com');
		init_setHeaderText();
	</script>
	<script>
		if (!!location.protocol.match(/https?:/) && location.origin!='https://n138-kz.github.io') {
			location.replace('https://n138-kz.github.io/sendFile2Discos/');
		}
	</script>
	<script>
        async function getGithubRepos(repos=null) {
            let url='https://api.github.com/repos/';
            if (repos===null) { repos=''; }
            url += repos;

            const response = await fetch(url);
            const json = await response.json();
            return await json;
        }
        async function getGithubRatelimit() {
            let url='https://api.github.com/rate_limit';

            const response = await fetch(url);
            const json = await response.json();
            return await json;
        }
        async function getGithubDeployment(github={deployments_url:''}) {
            if (github.deployments_url==false) { return []; }
            let url=github.deployments_url;

            let response = await fetch(url);
            let json = await response.json();
            json = await json[0];

            url=await json.statuses_url;
            response = await fetch(url);
            json = await response.json();
            return await json;
        }
        async function getIPaddress() {
            let url='https://api.n138.jp/isJP/';

            const response = await fetch(url);
            const json = await response.json();
            return await json.result;
        }
        async function getConfig(path='config.json') {
            let url=location.origin+location.pathname+path;

            const response = await fetch(url);
            const json = await response.json();
            return await json;
        }
        async function pushToDiscord() {
            const loaded_config=await getConfig();
            let wh_endpoint=loaded_config.external.discord.webhooks[0].url;
            wh_endpoint=wh_endpoint.split('/');
            wh_endpoint[wh_endpoint.length-2]=atob(wh_endpoint[wh_endpoint.length-2]);
            wh_endpoint[wh_endpoint.length-1]=atob(wh_endpoint[wh_endpoint.length-1]);
            wh_endpoint=wh_endpoint.join('/');
            
            let url=wh_endpoint;
            let header=new Headers();
            header.append('Content-Type', 'multipart/form-data');
            let files=Array.from(document.querySelector('#sendFile2Discos_main #files').files);
            let content=document.querySelector('#sendFile2Discos_main #content').value+'\n```json\n'+JSON.stringify({
                'message': document.querySelector('#sendFile2Discos_main #content').value,
                'remote_address': sessionStorage.getItem( (btoa(location.href)).slice(0, 16) + '.'+'n138kz.isJP' ),
                'location_href': location.origin+location.pathname,
                'event_at': new Date().getTime()/10**3,
            })+'\n```';
            console.log({
                'url': url,
                'header': header,
                'files': files,
                'content': content,
            });
            
        }
        window.addEventListener('DOMContentLoaded', async ()=>{
            let domitem=[];
            const isJP=await getIPaddress();
            if (!isJP.result.result) { location.replace('https://n138-kz.github.io/'); }
            sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'n138kz.isJP', JSON.stringify(isJP) );
            const remote_addr=isJP.request;
            domitem[0]=document.createElement('a');
            domitem[0].href=`https://ipinfo.io/${remote_addr.request}`;
            domitem[0].innerText=`${remote_addr.detail}`;
            document.querySelector('#remote_address_print').appendChild(domitem[0]);

            const github_repos=await getGithubRepos('n138-kz/sendFile2Disco');
            sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'github.repos.current', JSON.stringify(github_repos) );
            sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'github.repos.'+github_repos.full_name.replace('/','.'), JSON.stringify(github_repos) );
            const github_deploy=await getGithubDeployment(github_repos);
            sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'github.deploy.latest', JSON.stringify(github_deploy) );
            const github_rates=await getGithubRatelimit();
            github_rates.rate.reset_humanable=new Date(github_rates.rate.reset);
            sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'github.ratelimit', JSON.stringify(github_rates) );
            
            document.querySelector('#sendFile2Discos_main #files').addEventListener('change',(e)=>{
                console.log(e.target.files);
                document.querySelector('#sendFile2Discos_main #content').value='Attated files:';
                Array.from(e.target.files).map((e1)=>{
                    document.querySelector('#sendFile2Discos_main #content').value+=` ${e1.name}`;
                });
                if (document.querySelector('#sendFile2Discos_main #content').value.length>=2000) {
                    document.querySelector('#sendFile2Discos_main #content').value='Attated '+Array.from(e.target.files).length+' files';
                }
            });
		});
	</script>
</head>
<body>
    <form action="" method="POST" accept="multipart/form-data" id="sendFile2Discos_main">
        <table>
            <thead>
                <tr>
                    <th></th>
                    <td><span id="remote_address_print"></span></td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>Files</th>
                    <td>
                        <input type="file" name="files" id="files" multiple>
                    </td>
                </tr>
                <tr>
                    <th>Description</th>
                    <td>
                        <input type="text" name="content" id="content" required>
                    </td>
                </tr>
                <tr>
                    <th></th>
                    <td>
                        <input type="button" value="Submit" onclick="pushToDiscord">
                    </td>
                </tr>
            </tbody>
        </table>
    </form>
</body>
</html>
